<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
	<style type="text/css">
		.hiddenfile {
		 top:-100px;
		}
		.Unicens-glyph:before {
    		content: "\f1b3";
    		position : relative;
    		left : 3px;
    		color : #944;
    		font-family: FontAwesome;
		}
		.Node-glyph:before {
    		content: "\f1b2";
    		position : relative;
    		left : 3px;
    		color : #944;
    		font-family: FontAwesome;
		}		
		.SyncConnection-glyph:before {
    		content: "\f0ec";
    		position : relative;
    		left : 3px;
    		color : #494;
    		font-family: FontAwesome;			
		}		
		
		.MOSTSocket-glyph:before {
    		content: "\f1e6";
    		position : relative;
    		left : 5px;
    		color : #f99;
    		font-family: FontAwesome;			
		}
		.USBSocket-glyph:before {
    		content: "\f287";
    		position : relative;
    		left : 24px;
    		color : #494;
    		font-family: FontAwesome;			
		}
		.StreamSocket-glyph:before {
    		content: "\f1da";
    		position : relative;
    		left : 24px;
    		color : #494;
    		font-family: FontAwesome;			
		}		
		.MediaLBSocket-glyph:before {
    		content: "\f1e0";
    		position : relative;
    		left : 3px;
    		color : #494;
    		font-family: FontAwesome;			
		}
		.Combiner-glyph:before {
    		content: "C";
    		position : relative;
    		left : 3px;
    		color : #944;
		}
		.Splitter-glyph:before {
    		content: "S";
    		position : relative;
    		left : 3px;
    		color : #944;
		}
		/*USB content: "\f287";*/
		.StreamPort-glyph:before {
    		content: "\f2db";
    		position : relative;
    		left : 3px;
    		color : #494;
    		font-family: FontAwesome;			
		}
		.USBPort-glyph:before {
    		content: "\f2db";
    		position : relative;
    		left : 24px;
    		color : #494;
    		font-family: FontAwesome;			
		}		
		.Script-glyph:before {
    		content: "\f0f6"; 
    		position : relative;
    		left : 4px;
    		color : #448;
    		font-family: FontAwesome;			
		}		
		.I2CPortCreate-glyph:before {
    		content: "\f1b2";
    		position : relative;
    		left : 24px;
    		color : #448;
    		font-family: FontAwesome;			
		}
		.I2CPortWrite-glyph:before {
    		content: "\f045";
    		position : relative;
    		left : 24px;
    		color : #448;
    		font-family: FontAwesome;			
		}
		.GPIOPortPinMode-glyph:before {
    		content: "\f0eb"; 
    		position : relative;
    		left : 26px;
    		color : #448;
    		font-family: FontAwesome;			
		}
		.comment-glyph:before {
    		content: "\f27b"; 
    		position : relative;
    		left : 3px;
    		color : #888;
    		font-family: FontAwesome;			
		}
		
		.Route-line {
			border-style: dotted;
			border-radius: 6px;
			border-right: thick #ff0000;
			padding : 0px 0px 0px 120px;
			margin : -0px -7px;
			border-width : 1.3pt;
			border-color : #f00;
			box-sizing : border-box;
		}
		.Route-in-glyph:after {
    		content: "IN"; 
    		position : relative;
    		left : 10px;
    		color : #f77;
		}
		.Route-out-glyph:after {
    		content: "OUT"; 
    		position : relative;
    		left : 10px;
    		color : #f88;
		}		
		.Script-line {
			border-style: dotted;
			border-radius: 4px;
			border-right: thick #ff0000;
			padding : 0px 0px 0px 60px;
			margin : -0px -7px;
			border-width : 1.3pt;
			border-color : #00f;
			box-sizing : border-box;
		}		
		.Script-link-glyph:after {
    		content: "\f0c1"; 
    		font-size: 12px;
    		position : relative;
    		left : 4px;
    		top: 5px;
    		color : #a22;
    		font-family: FontAwesome;			
		}
		.Timeout-wait-glyph:after {
    		content: "\f252"; 
    		font-size: 10px;
    		position : relative;
    		left : -1px;
    		top: -2px;
    		color : #88f;
    		font-family: FontAwesome;			
		}
        html, body, .rb {
            margin: 0;
            height: 100%;
        }
        .rb {
            display: table;
            width: 100%;
            border-collapse: collapse;
        }
        .top, .editor {
            display: table-row;
        }

        .buffer {
            display: table-cell;
        }
        .top .buffer {
            height:1%;
        }
        #container {
            position:relative;
        }
        #container > * {
            overflow:auto;
            max-width:100%;
            max-height:100%;
        }
		[hidden] {
		  display: none !important;
		}
		#open-menu {
			margin : 0px 0px 0px 6px;
			width : 200px;
			text-align : left;
		}
	</style>
</head>
<body>

<div class="rb">
    <div class="top">
        <div class="buffer">
			<div class="btn-group">
			  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			    File</span>
			  </button>
			  <ul class="dropdown-menu">
			    <li><a id='new' href="#">New</a></li>
				<label class="btn" id='open-menu'>Open<input type="file" id='file' hidden></label>
			    <li><a id='save' href="#">Save as...</a></li>
			    <li role="separator" class="divider"></li>
			    <li><a id='sample1' href="#">Multichannel Audio Example</a></li>
			    <li><a id='sample2' href="#">USB Client/Server Example</a></li>
			  </ul>
			</div>
			<div class="btn-group">
			  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			    Help</span>
			  </button>
			  <ul class="dropdown-menu">
			    <li><a id='about' href="#" data-toggle="modal" data-target="#aboutDialog">About</a></li>
			  </ul>
			</div>
        </div>
    </div>
    <div class="editor">
        <div class="buffer" id="container">
        </div>
    </div>
</div>

<!-- Modal -->
<div id="aboutDialog" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">About</h4>
      </div>
      <div class="modal-body">
        <p>Cloud based editor for <a href='http://www.microchip.com/design-centers/automotive/most/unicens' target="_blank">UNICENS</a> configuration files.</p>
	<p></p>
	      <p>This code is using the following libraries:</p>
	      <ul>
		      <li><a href='https://lodash.com/' target="_blank">Loadsh</a></li>
		      <li><a href='https://jquery.com/' target="_blank">jQuery</a></li>
		      <li><a href='http://getbootstrap.com/' target="_blank">Bootstrap</a></li>
		      <li><a href='https://github.com/eligrey/FileSaver.js/' target="_blank">FileSaver.js</a></li>		      
		      <li><a href='https://microsoft.github.io/monaco-editor/' target="_blank">Monaco Editor</a></li>		      
	      </ul>
	      loadash, jQuery, Bootstrap, Monaco Editor</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.10.0/min/vs/loader.js"></script>

<script>
   "use strict";
    var $;
    var monaco;
	var showDecorations = true;
	var decorations;
	var editor;
	var xml;
	var xmlText;
	var model;
	var lines=[];

	// A $( document ).ready() block.
	$( document ).ready(function() {
	    console.log( "ready!" );
		require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.10.0/min/vs' }});
		require(['vs/editor/editor.main'], function() {
			createEditor();
			loadXmlIntoEditor('sample.xml');
			// register binding
			decorations = editor.deltaDecorations([], getDecorataionsList());
			// update decorations based on new model
			editor.onDidChangeModelContent(function(e) { 
				lines = model.getValue().split(/\r?\n/);
				var newDecorationsList = getDecorataionsList();
				decorations = editor.deltaDecorations(decorations, newDecorationsList);
			});
		});
	});
	$('#new').on('click', function(event) {
	  event.preventDefault();
	  loadXmlIntoEditor('new.xml');
	});
	
	$('#open').on('click', function(event) {
	  //event.preventDefault();
	  $('#file').trigger("click");
	});
	
	$('#save').on('click', function(event) {
	  event.preventDefault();
	   saveEditorFile(getXmlTextFromEditor(),'configuration.xml');
	  /*
	  var anchor = document.querySelector('#save');
	  console.log(anchor);
      anchor.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(getXmlTextFromEditor());
      console.log(anchor.href);
      anchor.download = 'configuration.xml';	  
      */
	});	
	$('#sample1').on('click', function(event) {
	  event.preventDefault();
	  loadXmlIntoEditor('https://raw.githubusercontent.com/MicrochipTech/unicens-linux-daemon/master/cfg/config_multichannel_audio_kit.xml');
	});
	$('#sample2').on('click', function(event) {
	  event.preventDefault();
	  loadXmlIntoEditor('https://raw.githubusercontent.com/MicrochipTech/unicens-linux-daemon/master/cfg/config_all_devices.xml');
	});
	$('#about').on('click', function(event) {
	  event.preventDefault();
	  
	  
	});
	document.getElementById('file').onchange = function(){
	  var file = this.files[0];
	  var reader = new FileReader();
	  reader.onload = function(progressEvent){
	  	updateEditorFromText(this.result);
	  	$('#file-name').html(file);
	  };
	  reader.readAsText(file);
	};

	function createEditor() {
	editor = monaco.editor.create(document.getElementById('container'), {
		value: [
			'<?xml version="1.0" encoding="UTF-8"?>',
			'<Unicens xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" AsyncBandwidth="20" xsi:noNamespaceSchemaLocation="unicens.xsd">',
		].join('\n'),
		//theme: "vs-dark",
		folding : true,
		lineNumbers : true,
		glyphMargin: true,
		roundedSelection: true,
		scrollBeyondLastLine: false,
		automaticLayout: true,
		language: 'xml'
		});
	}
	
	//You can get the current line text via: editor.getModel().getLineContent(editor.getPosition().lineNumber)
	//There are many events on the editor such as editor.onDidChangeModelContent(function(e) { console.log(e); })
	//You can invoke the indent action via editor.trigger('anyString', 'editor.action.indentLines', null) and the outdent via editor.trigger('anyString', 'editor.action.outdentLines', null)
	//monaco.editor.setModelMarkers(editor.editor.getModel(), 'java', monacoErrors);

	//load XML into editor, initializes globals
	function loadXmlIntoEditor(fileName) {
		xmlText=loadXmlText(fileName);
	}
	
	function saveEditorFile(content,savedFileName) {
		var blob = new Blob([content], {type: "text/plain;charset=utf-8"});
		saveAs(blob, savedFileName);
	}
	
	function getXmlTextFromEditor() {
		model = editor.getModel();
		return model.getValue();
	}

	function updateEditorFromText(xmlText) {
		model = editor.getModel();
		model.setValue(xmlText);
		lines = model.getValue().split(/\r?\n/);
	}
	
	// apply decorations
	function getDecorataionsList() {
		
		// insert decorations
		if (showDecorations) {
			var decorationsList = [];
			var hitCounter=0;
			for (var lineNumber in lines) {
				var line=lines[lineNumber];
				
				lineNumber = parseInt(lineNumber);
				
				pushTagDecoration(line,lineNumber,'Unicens',decorationsList);
				pushTagDecoration(line,lineNumber,'Node',decorationsList);

				if (
				pushTagDecoration(line,lineNumber,'SyncConnection',decorationsList)
				) {
					hitCounter=0;
				}
				
				// network 
				if (
				pushTagDecoration(line,lineNumber,'MOSTSocket',decorationsList)||
				pushTagDecoration(line,lineNumber,'Splitter',decorationsList)||
				pushTagDecoration(line,lineNumber,'Combiner',decorationsList)
				) {
					//hitCounter=0;
				}
				
				// peripherials
				if (
				pushTagDecoration(line,lineNumber,'USBSocket',decorationsList)||
				pushTagDecoration(line,lineNumber,'StreamSocket',decorationsList)||
				pushTagDecoration(line,lineNumber,'MediaLBSocket',decorationsList)||
				pushTagDecoration(line,lineNumber,'StreamPort',decorationsList)
				) {
					hitCounter=1;
				}
				
				// script
				pushTagDecoration(line,lineNumber,'Script',decorationsList);				
				pushTagDecoration(line,lineNumber,'I2CPortCreate',decorationsList);
				pushTagDecoration(line,lineNumber,'I2CPortWrite',decorationsList);
				pushTagDecoration(line,lineNumber,'GPIOPortPinMode',decorationsList);
				pushAttributeDecoration(line,lineNumber,'Timeout',decorationsList,'wait');
				
				// route attribute
				pushAttributeDecoration(line,lineNumber,'Route',decorationsList,hitCounter == 1 ? 'out' : 'in');
				// script attribute
				pushAttributeDecoration(line,lineNumber,'Script',decorationsList,'link');
				
				// other
				pushTagDecoration(line,lineNumber,'!--',decorationsList);
			}
			return decorationsList;
		}
	}
	
	// Pushes a decoration into decorationsList
	function pushTagDecoration(line,lineNumber,tag,decorationsList) {
		var match=false;
		var openTagIndex=line.indexOf('<'+tag);
		var closeTagIndex=line.indexOf('</'+tag);
		if (tag=='!--') {
			tag='comment';
		}
		if (
			(openTagIndex>=0)
			//||(closeTagIndex>=0)
			) {
			match=true;
			decorationsList.push({
					range: new monaco.Range(lineNumber+1,openTagIndex,lineNumber+1,openTagIndex+tag.length),
					options: {
						isWholeLine: true,
						className: tag+'-line',
						glyphMarginClassName: tag+'-glyph'
					}
				}				
				);
		}
		return match;
	}
	
	// Pushes a decoration into decorationsList
	function pushAttributeDecoration(line,lineNumber,text,decorationsList,direction) {
		var match=false;
		var search = line.replace(/\s/g, '');
		var textIndex=line.indexOf(text);
		if (search.indexOf(text+'="')>=0) {
			match=true;
			decorationsList.push({
					range: new monaco.Range(lineNumber+1,textIndex+1,lineNumber+1,textIndex+text.length+1),
					options: {
						isWholeLine: false,
						className: text+'-line',
						glyphMarginClassName: text+'-'+direction+'-glyph'
					}
				}				
				);
		}
		return match;
	}	
	
	//Load XML and return the XML DOM object
    function loadXml(fileName) {
      var Connect = new XMLHttpRequest();
      Connect.open("GET", fileName, false);
      Connect.setRequestHeader("Content-Type", "text/xml");
      Connect.send(null);
      //var unicens = xml.childNodes[0];
      return Connect.responseXML;
    }
    
    function loadXmlText(fileName) {
		$.ajax({
		            url : fileName,
		            dataType: "text",
		            success : function (data) {
		                updateEditorFromText(data);
		            }
		        });
    }

    
</script>

</body>
</html>
