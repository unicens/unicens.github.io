<!DOCTYPE html>
<!-- HTML5 Hello world by kirupa - http://www.kirupa.com/html5/getting_your_feet_wet_html5_pg1.htm -->
<html lang="en-us">

<head>
<!-- Load the Paper.js library -->
<!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.22/paper.min.js"></script> -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.11.5/paper-full.min.js"></script>
<meta charset="utf-8">

<!-- Font Awesome -->
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<title>Hello...</title>
<style type="text/css">
#mainContent {
	font-family: Arial, Helvetica, sans-serif;
	font-size: xx-large;
	font-weight: bold;
	background-color: #E3F0FB;
	border-radius: 4px;
	padding: 10px;
	text-align: center;
}
.buttonStyle {
	border-radius: 4px;
	border: thin solid #F0E020;
	padding: 5px;
	background-color: #F8F094;
	font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
	font-weight: bold;
	color: #663300;
	width: 75px;
}

#canvas  {
	width: 100%;
	height : 1000px;
}

.buttonStyle:hover {
	border: thin solid #FFCC00;
	background-color: #FCF9D6;
	color: #996633;
	cursor: pointer;
}
.buttonStyle:active {
	border: thin solid #99CC00;
	background-color: #F5FFD2;
	color: #669900;
	cursor: pointer;
}
#filedrag
{
	display: none;
	font-weight: bold;
	text-align: center;
	padding: 1em 0;
	margin: 1em 0;
	color: #555;
	border: 2px dashed #555;
	border-radius: 7px;
	cursor: default;
}
#filedrag.hover
{
	color: #f00;
	border-color: #f00;
	border-style: solid;
	box-shadow: inset 0 3px 4px #888;
}

</style>
</head>

<body>
	<i class="fa fa-arrow-circle-up"></i>
<canvas id="canvas" resize></canvas>

<script> 
  paper.install(window);
  
  var nodeSize = 48;
  var textSize = 12;
   
  var phyColor = 'red';
  var networkLocked = true;

  var dict = {
  	'MOSTSocket' : 'NET',
  	'StreamSocket' : 'I2S',
  	'MediaLBSocket' : 'MLB',
  	'USBSocket' : 'USB',
  	'Splitter' : 'SPL',
  	'Combiner' : 'CMB'
  }
  
  //var rendering = 'ring';
  var rendering = 'daisy';  

	//myButton.addEventListener('click', doSomething, false)

function xlt(term) {
	if (dict[term]) {
		return dict[term];
	} else {
		return term;
	}
}

    // parameters
    var headLength = 10;
    var headAngle = 150;
    var arrowColor = 'black';

    // the arrow
    var arrow = null;

    function drawArrow(start, end) {

        var tailLine = new Path.Line(start, end);
        var tailVector = end - start;
        var headLine = tailVector.normalize(headLength);

    	arrow = new Group([
	    	new Path([start, end]),
		    new Path([
			    end + headLine.rotate(headAngle),
			    end,
			    end + headLine.rotate(-headAngle)
		    ])
	    ]);
	
	    arrow.strokeColor = arrowColor;
    }
    
    
function drawText(x,y,color,stroke,size,caption) {
	var text = new PointText(new Point(x, y+2));
	text.justification = 'center';
	text.fontSize = textSize * size;
	text.fillColor ='white';
	text.content = caption;
	
	var text = new PointText(new Point(x, y-2));
	text.justification = 'center';
	text.fontSize = textSize * size;
	text.fillColor ='white';
	text.content = caption;	
	
	var text = new PointText(new Point(x-2, y));
	text.justification = 'center';
	text.fontSize = textSize * size;
	text.fillColor ='white';
	text.content = caption;		
	
	var text = new PointText(new Point(x+2, y));
	text.justification = 'center';
	text.fontSize = textSize * size;
	text.fillColor ='white';
	text.content = caption;			
	
	var text = new PointText(new Point(x, y));
	text.justification = 'center';
	text.fontSize = textSize * size;
	text.fillColor =color;
	text.content = caption;	
}

function drawNode(x,y,size,xmlNode) {
    var address = xmlNode.getAttribute("Address");
    var name = xmlNode.getAttribute("Name");
    var script = xmlNode.getAttribute("Script");
    var childNodes = xmlNode.children;
    nodeSize = 100;

	//var node = new Path.Circle(new Point(x, y), size);
	//node.fillColor = '#ffeeee';
	//node.strokeColor = 'red';
	
	var ofsx = x;
	var ofsy = y;
	var height = 0;

	var text = address;
	if (name) {
		text = name + ' ['+address + ']';
	}
	drawText(ofsx,ofsy,'black','red',0.8,text);
	
	//drawText(ofsx,ofsy,'black','red',0.8,(name) ? address : name + ' [' + address + ']');
	//drawText(ofsx,ofsy,'black','red',0.8,script);

	// paint routing
	for (var i=0; i<childNodes.length;i++) {
		var routeElement = xmlNode.children[i];
		var tagName = routeElement.tagName;
		if (tagName.toLowerCase().indexOf('connection')>=0) {
			var source = routeElement.children[0];
			var sink = routeElement.children[1];
			var sourceId = xlt(source.tagName);
			var sinkId = xlt(sink.tagName);
			var line;
			if ('NET,CMB,SPL'.indexOf(sourceId)>=0) {
				// FROM NET TO PERIPHERIALS (from NET)
				if ('CMB,SPL'.indexOf(sourceId)>=0) {
					// splitter, combiner
					var offsets = source.children;
					for (var j=0;j<offsets.length;j++) {
						var ofsElement=offsets[j];
						var prefix = ofsElement.getAttribute('Offset');
						sourceId = xlt(ofsElement.tagName);
						drawText(ofsx - nodeSize,ofsy,'red','white',0.7,sourceId+'-'+prefix+'>');
						drawText(ofsx + nodeSize,ofsy,'green','white',0.7,'>'+sinkId);
						height+=16;ofsy+=height;
					}
				} else {
					// simple socket
					drawText(ofsx - nodeSize,ofsy,'red','white',0.7,sourceId+'>');
					drawText(ofsx + nodeSize,ofsy,'green','white',0.7,'>'+sinkId);
					height+=16;ofsy+=height;
				}
			} else {
				// FROM PERIPHERIALS TO NET (to NET)
				drawText(ofsx - nodeSize,ofsy,'red','white',0.7,'<'+sinkId);
				drawText(ofsx + nodeSize,ofsy,'green','white',0.7,sourceId+'<');
				height+=16;ofsy+=height;
			}
		}
	}

	if (script) {
		
	}
	
	height+=16;ofsy+=height;
	
    //var node = new Path.Rectangle(x-size, y-height/2+4, size*2, height);
	//node.fillColor = '#d0d0d0';
	//node.opacity = 0.3;
	//node.strokeColor = 'red';

	return height;
}

function loadXml() {
  
  var canvas = document.getElementById('canvas');
  
  paper.setup(canvas);
  
  var w = canvas.width;
  var h = canvas.height;
  
  var cx = w/2;
  var cy = h/2;
  var networkRadius = Math.min(cx,cy) * 0.7;
  var routeRadius = Math.min(cx,cy) * 0.4;
	
  // Create a connection to the file.
  var Connect = new XMLHttpRequest();
  
  Connect.open("GET", "sample.xml", false);
  Connect.setRequestHeader("Content-Type", "text/xml");
  Connect.send(null);
  
  var xml = Connect.responseXML;
  
  var unicens = xml.childNodes[0];
  
  var nodes = unicens.getElementsByTagName('Node');
  var scripts = unicens.getElementsByTagName('Scripts');
    
  switch (rendering) {
  	case 'ring' : 
		var networkPhy = new Path.Circle(new Point(cx, cy), routeRadius);
		networkPhy.strokeColor = networkLocked ? phyColor : 'gray';
  		break;
  }

  var x = 200 + nodeSize * 1.6;
  var y = nodeSize * 1;
  var ofs = y;
  for (var i = 0; i < nodes.length; i++)
  {
   var node = nodes[i];
	switch (rendering) {   
		case 'ring' : 
			drawNode(cx + networkRadius * Math.sin(2*Math.PI*i/nodes.length), cy + networkRadius*Math.cos(2*Math.PI*i/nodes.length), nodeSize,node);
			break;
		case 'daisy' : 
			ofs += drawNode(x,ofs,nodeSize,node)+10;
			
			break;
	}
  }
  
  paper.view.draw();
  
function onFrame(event) {

	}  
	
}

function doSomething() {
	loadXml();
}

loadXml();
</script>

</body>
</html>

